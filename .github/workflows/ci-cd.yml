name: CI/CD - Python Semantic Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:

  delete-rc-tags:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Ensure all tags are fetched

      - name: List and Delete Tags Containing 'rc'
        id: list_tags
        run: |
          echo "Searching for tags containing 'rc'..."
          TAGS=$(git tag --list "*rc*")
          echo "Found tags:"
          echo "$TAGS"
          echo "## Tags \n\n $TAGS" >> $GITHUB_STEP_SUMMARY
          if [ -z "$TAGS" ]; then
            echo "No tags containing 'rc' found."
            echo "tags_to_delete=" > tags.log
          else
            echo "tags_to_delete=$TAGS" > tags.log

            echo "Deleting local tags..."
            echo $TAGS | xargs -n 1 git tag -d

            echo "Deleting remote tags..."
            for TAG in $TAGS; do
              git push origin --delete $TAG || echo "Failed to delete $TAG from remote."
            done
          fi

      - name: Success Message
        run: |
          echo "Completed deleting all tags containing 'rc'." >> $GITHUB_STEP_SUMMARY

  # Python Semantic Release          
  semantic-release:
    runs-on: ubuntu-latest

    steps:
      # Note: we need to checkout the repository at the workflow sha in case during the workflow
      # the branch was updated. To keep PSR working with the configured release branches,
      # we force a checkout of the desired release branch but at the workflow sha HEAD.
      - name: Setup | Checkout Repository at workflow sha
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}
          
      - name: Setup | Force correct release branch on workflow SHA
        run: |
          git checkout -B ${{ github.ref_name }}

      - name: Python Semantic Release
        uses: python-semantic-release/python-semantic-release@v9.15.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          git_committer_email: "62562712+pranavmishra90@users.noreply.github.com"
          ssh_private_signing_key: ${{ secrets.AUTOMATED_SIGNING_KEY }}
          ssh_public_signing_key: ${{ secrets.AUTOMATED_SIGNING_PUBKEY }}
          vcs_release: "true"
          changelog: "true"
          commit: "true"
          push: "true"
          root_options: "-v"